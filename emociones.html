<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MiAlmanake ‚Äî Diario de Emociones</title>
    <meta name="description" content="Calendario para registrar y reflexionar sobre tus emociones diarias" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="index.html">MiAlmanake</a>
        <nav class="site-nav" aria-label="Principal">
          <ul>
            <li><a href="index.html#inicio">Inicio</a></li>
            <li><a href="index.html#caracteristicas">Caracter√≠sticas</a></li>
            <li><a href="index.html#contacto">Contacto</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main id="diario-emociones" class="section journal emociones">
      <section class="hero">
        <div class="container">
          <h1>Diario de Emociones</h1>
          <p>Registra c√≥mo te sientes y descubre patrones en tu bienestar.</p>
        </div>
      </section>

      <section>
        <div class="container">
          <div id="app"></div>
          <noscript>Esta p√°gina requiere JavaScript para funcionar.</noscript>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>¬© <span id="year"></span> MiAlmanake. Todos los derechos reservados.</p>
      </div>
    </footer>

    <!-- React + ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel para interpretar JSX en el navegador (solo para esta p√°gina) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      /************************************
       * App De Calendario De Estado De √Ånimo (v1.11)
       * - RESTORE APP: Se repone la app completa (la versi√≥n anterior se hab√≠a sobrescrito por error con solo vinculoEmoji)
       * - FIX: vinculoEmoji actualizado: Creencias=‚úùÔ∏è, Clima=üåà, Ambiente=üå≥, Mascotas=üê∂
       * - Tests ampliados
       ************************************/

      // === Utilidades de fechas ===
      const pad = (n) => (n < 10 ? `0${n}` : `${n}`);
      const dateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
      const firstDayOfMonth = (y, m) => new Date(y, m, 1).getDay(); // 0=Domingo
      const isWeekendDate = (y, m, d) => {
        const wd = new Date(y, m, d).getDay();
        return wd === 0 || wd === 6; // domingo o s√°bado
      };

      // ID √∫nico robusto
      function makeId() {
        try { if (globalThis.crypto && typeof globalThis.crypto.randomUUID === 'function') return globalThis.crypto.randomUUID(); } catch {}
        return `id_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
      }

      // Paleta reducida de emojis arrastrables (caritas)
      const EMOJI_PALETTE = ["üòÄ", "üòê", "üò¢"];

      // Emociones con color sem√°ntico
      const MOOD_COLORS = [
        { name: "Miedo", color: "#7e22ce" },      // Morado
        { name: "Amor propio", color: "#22c55e" }, // Verde
        { name: "Tristeza", color: "#3b82f6" },    // Azul
        { name: "Amor", color: "#f97316" },        // Naranja
        { name: "Enfado", color: "#ef4444" },      // Rojo
        { name: "Alegr√≠a", color: "#eab308" }      // Amarillo
      ];

      // Opciones de V√≠nculo (cajitas blancas)
      const VINCULO_OPTIONS = [
        "Familia", "Pareja", "Trabajo", "Ocio", "Creencias", "Amigos", "Desconocido",
        "Clima", "Ambiente", "Dinero", "Actualidad", "Mascotas", "Sexo"
      ];

      // Asocia un emoji a cada v√≠nculo (actualizado)
      function vinculoEmoji(v) {
        const map = {
          "Familia": "üë™",
          "Pareja": "‚ù§Ô∏è",
          "Trabajo": "üíº",
          "Ocio": "üéâ",
          "Creencias": "‚úùÔ∏è",
          "Amigos": "üë•",
          "Desconocido": "‚ùì",
          "Clima": "üåà",
          "Ambiente": "üå≥",
          "Dinero": "üí∞",
          "Actualidad": "üóûÔ∏è",
          "Mascotas": "üê∂",
          "Sexo": "üíã",
        };
        return map[v] || "‚ùì";
      }

      const STORAGE_KEY = "moodCalendar.v1";

      // === Utilidades de color ===
      function hexToRgba(hex, alpha = 0.18) {
        const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!m) return hex;
        const r = parseInt(m[1], 16);
        const g = parseInt(m[2], 16);
        const b = parseInt(m[3], 16);
        return `rgba(${r},${g},${b},${alpha.toFixed(2)})`;
      }
      function getContrastText(hex) {
        const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!m) return "#111827";
        const r = parseInt(m[1], 16) / 255;
        const g = parseInt(m[2], 16) / 255;
        const b = parseInt(m[3], 16) / 255;
        const srgb = [r, g, b].map((v) => (v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4)));
        const L = 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
        return L > 0.5 ? "#111827" : "#ffffff";
      }
      function monthThemeColor(data, year, month) {
        const counts = new Map();
        for (let d = 1; d <= daysInMonth(year, month); d++) {
          const key = dateKey(new Date(year, month, d));
          const rec = data[key]?.[0];
          if (rec?.color) counts.set(rec.color, (counts.get(rec.color) || 0) + 1);
        }
        let top = null, max = 0;
        counts.forEach((v, k) => { if (v > max) { max = v; top = k; } });
        return top; // puede ser null
      }

      // === Estado por d√≠a: forzar un solo registro ===
      function setSingleRecord(prevState, dKey, record) {
        const next = { ...prevState };
        next[dKey] = record ? [record] : [];
        return next;
      }
      function normalizeToSingle(list) {
        if (!Array.isArray(list) || list.length === 0) return [];
        return [list[0]];
      }

      // === Etiqueta textual para el emoticono ===
      function emojiMoodLabel(emoji) {
        if (emoji === "üòÄ") return "muy contento";
        if (emoji === "üò¢") return "muy triste";
        return "normal"; // por defecto
      }

      // === UI: Chips blancos reutilizables ===
      function InfoChip({ children, title }) {
        return (
          <div
            className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs shadow-sm border border-slate-200 bg-white"
            title={title || ""}
          >
            {children}
          </div>
        );
      }

      // Modal simple
      function Modal({ open, onClose, children }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center">
            <div className="absolute inset-0 bg-black/40" onClick={onClose} />
            <div className="relative z-10 w-[min(92vw,640px)] max-h-[86vh] overflow-auto rounded-2xl bg-white p-4 shadow-xl">
              {children}
            </div>
          </div>
        );
      }

      // Editor de un registro
      function RecordEditor({ record, onChange, onDelete }) {
        return (
          <div className="flex flex-col gap-4">
            {/* Emoticono */}
            <div className="flex items-center gap-3 flex-wrap">
              <label className="text-sm font-medium text-slate-700">Emoticono</label>
              <div className="flex gap-2">
                {EMOJI_PALETTE.map((em) => (
                  <button
                    key={em}
                    className={`rounded-lg px-2 py-1 text-lg hover:bg-slate-100 ${record.emoji === em ? 'ring-2 ring-slate-400' : ''}`}
                    onClick={() => onChange({ ...record, emoji: em })}
                    type="button"
                  >
                    {em}
                  </button>
                ))}
              </div>
            </div>

            {/* Emoci√≥n / Color */}
            <div className="flex flex-col gap-2">
              <label className="text-sm font-medium text-slate-700">Emoci√≥n / Color</label>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                {MOOD_COLORS.map((m) => (
                  <button
                    key={m.name}
                    className={`flex items-center justify-center rounded-xl border px-2 py-1 text-sm font-medium ${record.color === m.color ? 'ring-2 ring-slate-500' : ''}`}
                    style={{ background: m.color, color: '#fff' }}
                    onClick={() => onChange({ ...record, color: m.color, comment: record.comment ? record.comment : m.name })}
                    type="button"
                    title={m.name}
                  >
                    {m.name}
                  </button>
                ))}
              </div>
            </div>

            {/* V√≠nculo */}
            <div className="flex flex-col gap-2">
              <label className="text-sm font-medium text-slate-700">V√≠nculo</label>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                {VINCULO_OPTIONS.map((v) => (
                  <button
                    key={v}
                    className={`rounded-xl border px-3 py-2 text-sm font-medium bg-white ${record.vinculo === v ? 'ring-2 ring-slate-500' : ''}`}
                    onClick={() => onChange({ ...record, vinculo: v })}
                    type="button"
                    title={v}
                  >
                    <span className="mr-1">{vinculoEmoji(v)}</span>
                    {v}
                  </button>
                ))}
              </div>
            </div>

            {/* Comentario */}
            <div>
              <label className="mb-1 block text-sm font-medium text-slate-700">Comentario</label>
              <textarea
                value={record.comment || ''}
                onChange={(e) => onChange({ ...record, comment: e.target.value })}
                className="h-24 w-full resize-none rounded-lg border border-slate-300 p-2"
                placeholder="Escribe un comentario opcional..."
              />
            </div>

            <div className="flex justify-between">
              <button onClick={onDelete} className="rounded-xl bg-rose-50 px-4 py-2 text-sm font-medium text-rose-700 ring-1 ring-rose-200 hover:bg-rose-100" type="button">
                Eliminar registro
              </button>
            </div>
          </div>
        );
      }

      // Editor del d√≠a (una sola emoci√≥n por d√≠a)
      function DayEditor({ open, onClose, dateLabel, record, onChangeRecord }) {
        const [local, setLocal] = useState(record || null);
        useEffect(() => setLocal(record || null), [record]);

        const addDefault = () => setLocal({ id: makeId(), emoji: 'üòÄ', color: '#ffffff', comment: '', vinculo: null });

        return (
          <Modal open={open} onClose={onClose}>
            <h3 className="text-xl font-semibold text-slate-800 mb-4">{dateLabel}</h3>
            <div className="flex flex-col gap-4">
              {!local && (
                <button onClick={addDefault} className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" type="button">
                  A√±adir emoci√≥n del d√≠a
                </button>
              )}

              {local && (
                <div className="rounded-2xl bg-slate-50 p-3 ring-1 ring-slate-200">
                  <RecordEditor
                    record={local}
                    onChange={(r) => setLocal(r)}
                    onDelete={() => setLocal(null)}
                  />
                </div>
              )}

              <button
                onClick={() => { onChangeRecord(local); onClose(); }}
                className="rounded-2xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-500 disabled:opacity-50"
                type="button"
                disabled={!local}
              >
                Guardar
              </button>
            </div>
          </Modal>
        );
      }

      /********* Tests de desarrollo *********/
      function runDevTests() {
        // Test makeId unicidad (b√°sico)
        const set = new Set();
        for (let i = 0; i < 400; i++) set.add(makeId());
        console.assert(set.size === 400, "[TEST] makeId deber√≠a ser √∫nico en 400 iteraciones");

        // Test normalizaci√≥n a un solo registro
        const norm1 = normalizeToSingle([]);           console.assert(Array.isArray(norm1) && norm1.length === 0, "[TEST] normalize empty");
        const norm2 = normalizeToSingle([{a:1},{a:2}]);console.assert(norm2.length === 1, "[TEST] normalize trims to 1");

        // Test setSingleRecord sobrescribe
        const prev = { A: [{id: 'x'}] };
        const next = setSingleRecord(prev, 'A', {id: 'y'});
        console.assert(next.A.length === 1 && next.A[0].id === 'y', "[TEST] setSingleRecord debe reemplazar");

        // Tests de utilidades de color
        console.assert(hexToRgba('#ff0000', 0.2) === 'rgba(255,0,0,0.20)', '[TEST] hexToRgba rojo');
        console.assert(getContrastText('#000000') === '#ffffff' && getContrastText('#ffffff') === '#111827', '[TEST] getContrastText b√°sico');

        // Test fin de semana (13 Oct 2025 = Lunes, 11 Oct 2025 = S√°bado)
        console.assert(isWeekendDate(2025, 9, 13) === false, '[TEST] 2025-10-13 debe ser laborable');
        console.assert(isWeekendDate(2025, 9, 11) === true, '[TEST] 2025-10-11 debe ser fin de semana');

        // Tests de V√≠nculo
        console.assert(Array.isArray(VINCULO_OPTIONS) && VINCULO_OPTIONS.length === 13, '[TEST] VINCULO_OPTIONS debe tener 13 elementos');
        console.assert(vinculoEmoji('Creencias') === '‚úùÔ∏è', '[TEST] vinculoEmoji Creencias=‚úùÔ∏è');
        console.assert(vinculoEmoji('Clima') === 'üåà', '[TEST] vinculoEmoji Clima=üåà');
        console.assert(vinculoEmoji('Ambiente') === 'üå≥', '[TEST] vinculoEmoji Ambiente=üå≥');
        console.assert(vinculoEmoji('Mascotas') === 'üê∂', '[TEST] vinculoEmoji Mascotas=üê∂');
        console.assert(vinculoEmoji('XYZ') === '‚ùì', '[TEST] vinculoEmoji fallback');
      }

      function MoodCalendarApp() {
        const now = new Date();
        const [year, setYear] = useState(now.getFullYear());
        const [month, setMonth] = useState(now.getMonth());
        const [data, setData] = useState({}); // { dKey: [record] }
        const [dragEmoji, setDragEmoji] = useState(null);
        const [editorDay, setEditorDay] = useState(null);

        // Carga/guardado + tests
        useEffect(() => {
          // En navegador no se ejecutan tests de desarrollo
          if (typeof process !== 'undefined' && process.env && process.env.NODE_ENV !== 'production') {
            try { runDevTests(); } catch (e) { console.warn('[TEST] error', e); }
          }
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              const normalized = Object.fromEntries(
                Object.entries(parsed).map(([k, v]) => [k, normalizeToSingle(v)])
              );
              setData(normalized);
            } catch {}
          }
        }, []);
        useEffect(() => {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
        }, [data]);

        const monthName = useMemo(() => new Intl.DateTimeFormat('es-ES', { month: 'long' }).format(new Date(year, month, 1)), [year, month]);
        const monthColor = monthThemeColor(data, year, month);

        const totalDays = daysInMonth(year, month);
        const firstWeekday = firstDayOfMonth(year, month); // 0=domingo
        const leadingEmpty = (firstWeekday + 6) % 7; // lunes=0
        const weekdayLabels = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

        const goPrev = () => { const d = new Date(year, month - 1, 1); setYear(d.getFullYear()); setMonth(d.getMonth()); };
        const goNext = () => { const d = new Date(year, month + 1, 1); setYear(d.getFullYear()); setMonth(d.getMonth()); };

        // Drop de emoji: reemplaza el registro del d√≠a
        const onDropEmojiToDate = (dKey, emoji) => {
          setData((prev) => setSingleRecord(prev, dKey, { id: makeId(), emoji, color: '#ffffff', comment: '', vinculo: null }));
        };

        const openDayEditor = (dKey) => setEditorDay(dKey);
        const closeDayEditor = () => setEditorDay(null);

        const editorRecord = editorDay ? (data[editorDay] && data[editorDay][0]) || null : null;
        const saveEditorRecord = (rec) => setData((prev) => setSingleRecord(prev, editorDay, rec));

        const todayKey = dateKey(new Date());

        return (
          <div className="min-h-screen w-full p-4 text-slate-900" style={{ background: monthColor ? hexToRgba(monthColor, 0.12) : 'linear-gradient(to bottom, #f8fafc, #f1f5f9)' }}>
            <h1 className="text-2xl font-bold text-center mb-4">Calendario de Estado de √Ånimo</h1>

            {/* Barra de mes/a√±o te√±ida con dominante */}
            <div className="flex justify-between max-w-4xl mx-auto mb-4 items-center rounded-2xl ring-1 ring-slate-200 px-3 py-2"
              style={{ background: monthColor ? monthColor : '#ffffff', color: monthColor ? getContrastText(monthColor) : '#111827' }}>
              <button onClick={goPrev} className="rounded-2xl bg-white/80 px-3 py-2 text-sm font-medium shadow-sm ring-1 ring-slate-200 hover:bg-white" style={{ color: '#111827' }}>‚Üê Mes anterior</button>
              <div className="text-lg font-semibold capitalize">{monthName} {year}</div>
              <button onClick={goNext} className="rounded-2xl bg-white/80 px-3 py-2 text-sm font-medium shadow-sm ring-1 ring-slate-200 hover:bg-white" style={{ color: '#111827' }}>Mes siguiente ‚Üí</button>
            </div>

            {/* Paleta de emojis arrastrables */}
            <div className="mx-auto mb-4 max-w-4xl rounded-2xl bg-white p-3 shadow-sm ring-1 ring-slate-200">
              <div className="mb-1 px-1 text-xs font-medium text-slate-500">Paleta</div>
              <div className="flex flex-wrap gap-2">
                {EMOJI_PALETTE.map((em) => (
                  <div
                    key={em}
                    draggable
                    onDragStart={(e) => { setDragEmoji(em); e.dataTransfer.setData('text/plain', em); }}
                    onDragEnd={() => setDragEmoji(null)}
                    className={`cursor-grab select-none rounded-xl px-2 py-1 text-xl hover:bg-slate-100 ${dragEmoji === em ? 'ring-2 ring-slate-400' : ''}`}
                    title="Arrastra al calendario"
                  >
                    {em}
                  </div>
                ))}
              </div>
            </div>

            {/* Grid del calendario */}
            <div className="grid grid-cols-7 gap-1 max-w-4xl mx-auto">
              {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((w) => {
                const isWknd = w === 'S' || w === 'D';
                return (
                  <div
                    key={w}
                    className={`text-center text-sm font-medium border-b pb-1 ${isWknd ? 'text-indigo-600' : 'text-slate-500'}`}
                    title={isWknd ? 'Fin de semana' : 'D√≠a laborable'}
                  >
                    {w}
                  </div>
                );
              })}
              {Array.from({ length: ((firstWeekday + 6) % 7) }).map((_, i) => <div key={`empty-${i}`} />)}
              {Array.from({ length: daysInMonth(year, month) }).map((_, i) => {
                const day = i + 1;
                const dKey = dateKey(new Date(year, month, day));
                const rec = (data[dKey] && data[dKey][0]) || null;
                const isToday = dKey === todayKey;
                const isWeekend = isWeekendDate(year, month, day);
                const bg = rec?.color ? hexToRgba(rec.color, 0.18) : '#ffffff';
                return (
                  <div
                    key={dKey}
                    className={`relative flex aspect-square flex-col items-center justify-start gap-1 rounded-lg border p-2 hover:bg-slate-50 ${isWeekend ? 'border-dashed border-slate-400' : 'border-solid border-slate-300'} ${isToday ? 'ring-2 ring-emerald-400' : ''}`}
                    style={{ background: bg }}
                    onClick={() => openDayEditor(dKey)}
                    onDragOver={(e) => e.preventDefault()}
                    onDrop={(e) => { e.preventDefault(); const em = e.dataTransfer.getData('text/plain') || dragEmoji; if (em) onDropEmojiToDate(dKey, em); }}
                  >
                    <div className="absolute right-2 top-2 text-xs text-slate-600">{day}</div>

                    <div className="mt-5 flex w-full flex-col items-center gap-1">
                      {rec ? (
                        <>
                          {/* 1) Emoci√≥n: chip blanco con emoji + etiqueta */}
                          <InfoChip title="Emoci√≥n">
                            <span className="text-base leading-none">{rec.emoji}</span>
                            <span className="text-[11px] text-slate-700">{emojiMoodLabel(rec.emoji)}</span>
                          </InfoChip>

                          {/* 2) V√≠nculo seleccionado (emoji + texto) */}
                          {rec.vinculo ? (
                            <InfoChip title="V√≠nculo">
                              <span className="text-base leading-none mr-1">{vinculoEmoji(rec.vinculo)}</span>
                              <span className="text-[11px] text-slate-700">{rec.vinculo}</span>
                            </InfoChip>
                          ) : null}

                          {/* 3) Comentario */}
                          {rec.comment ? (
                            <InfoChip title={rec.comment}>
                              <span className="max-w-[140px] truncate text-[11px] text-slate-700">{rec.comment}</span>
                            </InfoChip>
                          ) : null}
                        </>
                      ) : (
                        <div className="text-[10px] text-slate-400">Sin emoci√≥n</div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Editor del d√≠a */}
            <DayEditor
              open={!!editorDay}
              onClose={closeDayEditor}
              dateLabel={editorDay || ''}
              record={editorRecord}
              onChangeRecord={saveEditorRecord}
            />

            <div className="mx-auto mt-6 max-w-4xl text-center text-xs text-slate-500">
              v1.11 ‚Ä¢ Datos locales (localStorage) ‚Ä¢ Arrastra un emoji para crear registro ‚Ä¢ Click en un d√≠a para editar
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('app'));
      root.render(<MoodCalendarApp />);
    </script>

    <script src="js/main.js" defer></script>
  </body>
  </html>

