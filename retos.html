<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MiAlmanake � Diario de Retos</title>
    <meta name="description" content="Define objetivos, supera obstaculos y sigue tu progreso" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Fondo y estilo como index (main) */
      body.wallpaper {
        background: url('assets/images/origami_01.png') center center / cover fixed no-repeat !important;
        color: #ffffff;
      }
      body.wallpaper .site-header,
      body.wallpaper .hero,
      body.wallpaper .site-footer { background: transparent !important; border-color: rgba(255,255,255,0.2) !important; }
      body.wallpaper .site-header .brand,
      body.wallpaper .site-nav a,
      body.wallpaper .hero h1,
      body.wallpaper .hero p,
      body.wallpaper .site-footer { color: #ffffff !important; }
      body.wallpaper main.retos .rounded-2xl.bg-white { background: linear-gradient(135deg, #40a9e8, #007fcc) !important; border-color: rgba(255,255,255,0.25) !important; }`r`n      body.wallpaper main.retos .actions-panel { background: #ffffff !important; color: #111827 !important; border-color: rgba(0,0,0,0.1) !important; }
      /* Botones primarios como en index */
      body.wallpaper .btn.primary { background: linear-gradient(135deg, #fde047, #f59e0b) !important; border-color: transparent !important; color: #111827 !important; }
      body.wallpaper .btn.primary:hover { background: linear-gradient(135deg, #f59e0b, #d97706) !important; color: #ffffff !important; }
      .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center; justify-content: center; z-index: 50; }
      .modal-card { width: min(92%, 680px); background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
      /* Botones Cerrar/Borrar: naranja por defecto, rojo al pasar el ratÃ³n */
      body.wallpaper .btn[data-action="close"],
      body.wallpaper .btn[data-action="delete"] {
        background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        border-color: transparent !important;
        color: #ffffff !important;
      }
      body.wallpaper .btn[data-action="close"]:hover,
      body.wallpaper .btn[data-action="delete"]:hover {
        background: linear-gradient(135deg, #ef4444, #b91c1c) !important;
        color: #ffffff !important;
      }          /* Bloque 1 (Calendario) fondo negro y texto blanco */
      body.wallpaper main.retos .calendar-panel { background: #000000 !important; color: #ffffff !important; border-color: rgba(255,255,255,0.2) !important; }
      body.wallpaper main.retos .calendar-panel * { color: #ffffff !important; }</style></style>
  </head>
  <body class="wallpaper">
    <header class="site-header">
      <div class="container">
        <a class="brand" href="index.html">MiAlmanake</a>
        <nav class="site-nav" aria-label="Principal">
          <ul>
            <li><a href="index.html#inicio">Inicio</a></li>
            <li><a href=" index.html#caracteristicas\>Caracter�sticas</a></li>
            <li><a href="index.html#contacto">Contacto</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main id="diario-retos" class="section retos">
      <section class="hero">
        <div class="container">
          <h1>Diario de Retos</h1>
          <p>Define objetivos, supera obstaculos y sigue tu progreso diario.</p>
        </div>
      </section>

      <section>
        <div class="container">
          <div id="app"></div>
          <noscript>Esta pï¿½gina requiere JavaScript para funcionar.</noscript>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>ï¿½ <span id="year"></span> MiAlmanake. Todos los derechos reservados.</p>
      </div>
    </footer>

    <!-- React + ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel para interpretar JSX (sin build) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // Utilidades de fecha
      const pad = (n) => (n < 10 ? `0${n}` : `${n}`);
      const dateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      const parseKey = (k) => { const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(k); if (!m) return null; return new Date(+m[1], +m[2]-1, +m[3]); };
      const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
      const firstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
      const isWeekendDate = (y, m, d) => { const wd = new Date(y, m, d).getDay(); return wd === 0 || wd === 6; };
      const humanMonth = (y, m) => new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(new Date(y, m, 1));
      const hexToRgba = (hex, alpha = 0.18) => { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!m) return hex; const r = parseInt(m[1],16), g = parseInt(m[2],16), b = parseInt(m[3],16); return `rgba(${r},${g},${b},${alpha})`; };
      const getContrastText = (hex) => { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!m) return '#111827'; const r=parseInt(m[1],16)/255, g=parseInt(m[2],16)/255, b=parseInt(m[3],16)/255; const s=[r,g,b].map(v=>v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4)); const L=0.2126*s[0]+0.7152*s[1]+0.0722*s[2]; return L>0.5?'#111827':'#ffffff'; };

      // Paleta y helpers de color por reto
      const RETO_COLORS = ['#0ea5e9','#3b82f6','#1d4ed8','#8b5cf6','#7c3aed','#a78bfa','#22c55e','#10b981','#059669','#14b8a6','#06b6d4','#f59e0b','#f97316','#ef4444'];
      const pickRetoColor = (existing) => { const used=new Set((existing||[]).map(r=>r.color).filter(Boolean)); for(const c of RETO_COLORS){ if(!used.has(c)) return c; } return RETO_COLORS[(existing?.length||0)%RETO_COLORS.length]; };

      // Datos
      const STORAGE_KEY = 'retos.v1';
      const OK_COLOR = '#22c55e';
      const FAIL_COLOR = '#ef4444';
      const makeId = () => `r_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
      const withinRange = (key, startKey, endKey) => !!startKey && !!endKey && key >= startKey && key <= endKey;

      function RetosApp() {
        const now = new Date();
        const [year, setYear] = useState(now.getFullYear());
        const [month, setMonth] = useState(now.getMonth());
        const [state, setState] = useState({ retos: [], activoId: null });

        useEffect(()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ setState(JSON.parse(raw)); } }catch{} },[]);
        useEffect(()=>{ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} },[state]);

        const retos = state.retos || [];
        const activo = useMemo(()=> retos.find(r=>r.id===state.activoId) || null, [retos, state.activoId]);

        useEffect(()=>{ if(!activo) return; const start = parseKey(activo.inicio); if(start){ setYear(start.getFullYear()); setMonth(start.getMonth()); } }, [state.activoId]);

        const addReto = (form) => {
          const nombre=(form.nombre||'').trim(); const descripcion=(form.descripcion||'').trim(); const inicio=form.inicio; const fin=form.fin;
          if(!nombre || !inicio || !fin || fin<inicio) return;
          const color = pickRetoColor(retos);
          const ret = { id: makeId(), nombre, descripcion, inicio, fin, color, progreso: {} };
          setState(s=>({ retos:[...retos, ret], activoId: ret.id }));
          return ret;
        };

        const deleteReto = (id) => { setState(s=>({ ...s, retos:(s.retos||[]).filter(r=>r.id!==id), activoId: s.activoId===id? null : s.activoId })); };

        const monthName = humanMonth(year, month);
        const firstWeekday = firstDayOfMonth(year, month);
        const leadingEmpty = (firstWeekday + 6) % 7;

        function BlockNuevoReto({ onSaved }){
          const [form, setForm] = useState({ nombre:'', descripcion:'', inicio:'', fin:'' });
          return (
            <div className="rounded-2xl border border-slate-200 bg-white p-4 actions-panel">
              <h2 className="mb-2 text-lg font-semibold">Nuevo Reto</h2>
              <div className="space-y-2">
                <div>
                  <label className="block text-sm">Nombre</label>
                  <input value={form.nombre} onChange={e=>setForm({...form, nombre:e.target.value})} type="text" className="w-full rounded border border-slate-300 px-2 py-1" placeholder="Ej. Leer 20 min diarios" />
                </div>
                <div>
                  <label className="block text-sm">Descripciï¿½n</label>
                  <textarea value={form.descripcion} onChange={e=>setForm({...form, descripcion:e.target.value})} className="w-full rounded border border-slate-300 px-2 py-1" rows={3} placeholder="Quï¿½, cuï¿½ndo y cï¿½mo" />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  <div>
                    <label className="block text-sm">Inicio</label>
                    <input value={form.inicio} onChange={e=>setForm({...form, inicio:e.target.value})} type="date" className="w-full rounded border border-slate-300 px-2 py-1" />
                  </div>
                  <div>
                    <label className="block text-sm">Fin</label>
                    <input value={form.fin} onChange={e=>setForm({...form, fin:e.target.value})} type="date" className="w-full rounded border border-slate-300 px-2 py-1" />
                  </div>
                </div>
                <div className="flex items-center justify-end">
                  <button type="button" className="btn primary" onClick={()=>{ const created = addReto(form); if(created && onSaved) onSaved(created); }}>Guardar</button>
                </div>
              </div>
            </div>
          );
        }

        function BlockAccionesRetos(){
          const [showCreate, setShowCreate] = useState(false);
          const [showDelete, setShowDelete] = useState(false);
          const [delId, setDelId] = useState('');
          return (
            <div className="rounded-2xl border border-slate-200 bg-white p-4 actions-panel">
              <h2 className="mb-3 text-lg font-semibold">Acciones</h2>
              <div className="flex flex-wrap gap-2">
                <button className="btn primary" onClick={()=>setShowCreate(true)}>Crear nuevo reto</button>
                <button className="btn" onClick={()=>setShowDelete(true)} data-action="delete">Borrar</button>
              </div>

              {showCreate && (
                <div className="modal-mask">
                  <div className="modal-card">
                    <div className="mb-2 flex items-center justify-between">
                      <div className="text-lg font-semibold">Crear nuevo reto</div>
                      <button className="btn" onClick={()=>setShowCreate(false)}>Cerrar</button>
                    </div>
                    <BlockNuevoReto onSaved={()=>setShowCreate(false)} />
                  </div>
                </div>
              )}

              {showDelete && (
                <div className="modal-mask">
                  <div className="modal-card" style={{width:'min(92%,560px)'}}>
                    <div className="mb-3 text-lg font-semibold">Selecciona cuï¿½l de ellos quieres eliminar</div>
                    {retos.length===0 ? (
                      <div className="text-sm">No hay retos para borrar.</div>
                    ) : (
                      <div className="space-y-3">
                        <select className="w-full rounded border border-slate-300 px-2 py-2" value={delId} onChange={e=>setDelId(e.target.value)}>
                          <option value="">ï¿½ Selecciona un reto ï¿½</option>
                          {retos.map(r=> (
                            <option key={r.id} value={r.id}>{r.nombre} ({r.inicio} ? {r.fin})</option>
                          ))}
                        </select>
                        <div className="flex items-center justify-end gap-2">
                          <button className="btn" onClick={()=>setShowDelete(false)}>Cancelar</button>
                          <button className="btn primary" data-action="delete" onClick={()=>{ if (delId) { setShowDelete(false); setDelId(''); deleteReto(delId);} }}>Aceptar</button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        }

        function BlockTusRetos(){
          return (
            <div className="rounded-2xl border border-slate-200 bg-white p-4 actions-panel">
              <h2 className="mb-2 text-lg font-semibold text-yellow-300">Tus Retos</h2>
              {retos.length===0 ? (
                <div className="text-sm">Aï¿½n no hay retos. Crea el primero para empezar.</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {retos.map(r=>{
                    const active = state.activoId===r.id;
                    const bg = active ? (r.color||'#3b82f6') : hexToRgba(r.color||'#3b82f6', 0.18);
                    const fg = active ? getContrastText(r.color||'#3b82f6') : '#111827';
                    const border = active ? 'transparent' : (r.color||'#3b82f6');
                    return (
                      <button key={r.id} onClick={()=>setActivo(r.id)} className="px-3 py-1 rounded-full border text-sm" style={{ background:bg, color:fg, borderColor:border }} title={`${r.nombre} (${r.inicio} ? ${r.fin})`}>
                        {r.nombre}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          );
        }

        function BlockCalendar(){
          const okBg = hexToRgba(OK_COLOR, 0.2);
          const failBg = hexToRgba(FAIL_COLOR, 0.18);
          const inRange = (dKey) => activo && withinRange(dKey, activo.inicio, activo.fin);
          return (
            <div className=" mt-6 calendar-panel rounded-2xl border border-slate-200 p-4\>
              <div className="mb-3 flex items-center justify-center gap-3">
                <button className="btn primary" onClick={()=>{ const m=new Date(year,month-1,1); setYear(m.getFullYear()); setMonth(m.getMonth()); }}>mes-anterior</button>
                <div className="text-lg font-semibold">{monthName}</div>
                <button className="btn primary" onClick={()=>{ const m=new Date(year,month+1,1); setYear(m.getFullYear()); setMonth(m.getMonth()); }}>mes-siguiente</button>
              </div>

              <div className="max-w-4xl mx-auto mb-1 rounded-2xl ring-1 ring-slate-200 px-3 py-1 bg-white/70">
                <div className="grid grid-cols-7 text-center text-sm font-semibold">
                  {['L','M','X','J','V','S','D'].map(w => <div key={w} className="py-0.5">{w}</div>)}
                </div>
              </div>

              <div className="grid grid-cols-7 gap-1 max-w-4xl mx-auto">
                {Array.from({ length: leadingEmpty }).map((_,i)=><div key={`empty-${i}`} />)}
                {Array.from({ length: daysInMonth(year, month) }).map((_, i) => {
                  const day = i+1; const dKey = dateKey(new Date(year,month,day));
                  const isWeekend = isWeekendDate(year,month,day);
                  const status = activo?.progreso?.[dKey] || null;
                  const inside = inRange(dKey);
                  const retoColor = activo?.color || '#3b82f6';
                  const styleBg = status==='ok'? okBg : (status==='fail'? failBg : (inside ? hexToRgba(retoColor, 0.18) : '#ffffff'));
                  const ringCls = inside ? 'ring-1 ring-emerald-200' : '';
                  const borderCls = inside
                    ? (status==='ok' ? 'border-emerald-500' : status==='fail' ? 'border-rose-500' : '')
                    : 'border-slate-200';
                  return (
                    <div key={dKey}
                      className={`relative flex aspect-square flex-col items-center justify-start gap-1 rounded-lg border p-2 hover:bg-slate-50 ${isWeekend? 'border-dashed' : 'border-solid'} ${borderCls} ${ringCls} ${inside? '' : 'opacity-40'}`}
                      style={{ background: styleBg, borderColor: (inside && !status) ? retoColor : undefined }}
                      onClick={()=> inside && toggleDay(dKey)}
                      title={inside? (status==='ok'?'Exito':'') + (status==='fail'?'Fallo':'') : 'Fuera de rango'}
                    >
                      <div className={`absolute right-2 top-2 font-bold text-base ${inside? 'text-black':'text-slate-500'}`}>{day}</div>
                      {status==='ok' && <div className="mt-6 text-2xl">?</div>}
                      {status==='fail' && <div className="mt-6 text-2xl">?</div>}
                      {!status && inside && <div className="mt-6 text-[11px] text-slate-400">Marca</div>}
                    </div>
                  );
                })}
              </div>
            </div>
          );
        }

        return (
          <div className="space-y-4">`r`n            <div className="grid grid-cols-4 gap-4">`r`n              <div className="lg:col-span-1">`r`n                <BlockAccionesRetos />`r`n              </div>`r`n              <div className="lg:col-span-3">`r`n                <BlockTusRetos />`r`n              </div>`r`n            </div>
            <BlockCalendar />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('app'));
      root.render(<RetosApp />);
    </script>

    <script src="js/main.js" defer></script>
  </body>
  </html>


